<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Page - Order/Payment Confirmation Page</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f6f8fb;
    margin: 0;
    padding: 20px;
  }

  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
  }

  .login-box {
    max-width: 360px;
    margin: 80px auto;
    padding: 25px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
  }

  .login-box input {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    font-size: 15px;
  }

  .login-box button {
    width: 100%;
    padding: 10px;
    margin-top: 15px;
    background: #2d89ef;
    border: none;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    border-radius: 4px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }

  th, td {
    padding: 10px;
    border: 1px solid #ddd;
    font-size: 14px;
    text-align: center;
  }

  th {
    background: #2d89ef;
    color: #fff;
  }

  button.confirm-btn {
    background: #28a745;
    color: #fff;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 4px;
  }

  button.confirm-btn:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
</style>
</head>

<body>

<h1>Admin Page - Order/Payment Confirmation Page</h1>

<!-- LOGIN -->
<div class="login-box" id="loginBox">
  <h3>Admin Login</h3>
  <input type="password" id="adminPassword" placeholder="Enter Admin Password">
  <button onclick="login()">Login</button>
</div>

<!-- ORDERS -->
<div id="ordersSection" style="display:none;">
  <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
    <input
      type="text"
      id="searchInput"
      placeholder="Search Order ID / Customer / Phone"
      onkeyup="applyFilters()"
      style="padding:8px; width:260px;"
    >
  
    <select id="statusFilter" onchange="applyFilters()" style="padding:8px;">
      <option value="">All Status</option>
      <option value="Pending">Pending</option>
      <option value="Payment Confirmed">Payment Confirmed</option>
      <option value="Confirmed">Confirmed</option>
    </select>
  </div>
  <table>
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Phone Number</th>
        <th>Total Amount</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>
</div>

<script>
let ALL_ORDERS = [];

const ADMIN_PASSWORD = "Neev@Kart#Admin!2026$";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8NulIj3LlhKVYub6iuH_mWyxaZORCnLS78gGBcyDDFjvNEOyhks1JugddaA-3wmu4/exec";

/*************** STATUS → ACTION MAP ***************/
const STATUS_FLOW = {
  "Order Received": {
    buttonText: "Confirm Payment",
    nextAction: "confirmPayment",
    disabled: false
  },
  "Payment Received": {
    buttonText: "Pick & Pack Items",
    nextAction: "pickPack",
    disabled: false
  },
  "Items Picked & Packed": {
    buttonText: "Deliver Order",
    nextAction: "deliverOrder",
    disabled: false
  },
  "Order Delivered": {
    buttonText: "Completed",
    nextAction: null,
    disabled: true
  }
};

/*************** LOGIN ***************/
function login() {
  const pwd = document.getElementById("adminPassword").value;
  if (pwd === ADMIN_PASSWORD) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("ordersSection").style.display = "block";
    loadOrders();
  } else {
    alert("❌ Incorrect password");
  }
}

/*************** LOAD ORDERS ***************/
function loadOrders() {
  fetch(SCRIPT_URL + "?action=getOrders")
    .then(res => res.json())
    .then(data => {
      ALL_ORDERS = data;
      renderOrders(data);
    })
    .catch(() => alert("❌ Failed to load orders"));
}

/*************** RENDER TABLE ***************/
function renderOrders(data) {
  const tbody = document.getElementById("ordersTable");
  tbody.innerHTML = "";

  data.forEach(order => {
    const orderId  = order[0];
    const customer = order[2];
    const phone    = order[3];
    const total    = order[10];
    const status   = order[14];

    const flow = STATUS_FLOW[status] || {
      buttonText: "N/A",
      disabled: true
    };

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${orderId}</td>
      <td>${customer}</td>
      <td>${phone}</td>
      <td>₹${total}</td>
      <td>${status}</td>
      <td>
        <button class="confirm-btn"
          ${flow.disabled ? "disabled" : ""}
          onclick="handleAction('${orderId}', '${flow.nextAction}')">
          ${flow.buttonText}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/*************** FILTER ***************/
function applyFilters() {
  const searchText = document.getElementById("searchInput").value.toLowerCase();
  const statusVal  = document.getElementById("statusFilter").value.toLowerCase();

  const filtered = ALL_ORDERS.filter(order => {
    const orderId  = String(order[0]).toLowerCase();
    const customer = String(order[2]).toLowerCase();
    const phone    = String(order[3]).toLowerCase();
    const status   = String(order[14]).toLowerCase();

    const matchesSearch =
      orderId.includes(searchText) ||
      customer.includes(searchText) ||
      phone.includes(searchText);

    const matchesStatus =
      !statusVal || status === statusVal;

    return matchesSearch && matchesStatus;
  });

  renderOrders(filtered);
}

/*************** ACTION HANDLER ***************/
function handleAction(orderId, action) {
  if (!action) return;

  let confirmMsg = "Proceed with this action?";
  if (action === "confirmPayment") confirmMsg = "Confirm payment for this order?";
  if (action === "pickPack") confirmMsg = "Mark items as picked & packed?";
  if (action === "deliverOrder") confirmMsg = "Mark order as delivered?";

  if (!confirm(confirmMsg)) return;

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: action,
      orderId: orderId
    })
  })
  .then(res => res.json())
  .then(resp => {
    if (resp.success) {
      alert("✅ Status updated successfully");
      loadOrders();
    } else {
      alert("❌ Action failed");
    }
  })
  .catch(() => alert("❌ Server error"));
}
</script>



</body>
</html>
